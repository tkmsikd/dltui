# Covesa DLTログビューアTUIツール仕様書

## プロジェクト概要
Covesa DLT（Diagnostic Log and Trace）ログファイルを解析し、ターミナル上で効率的に閲覧・分析するためのTUI（Text User Interface）ツールを開発する。主要なプラットフォームはmacOSとUbuntuを対象とし、Rust言語で実装する。

## 機能要件

### 1. 基本機能
- DLTバイナリログファイルの読み込みと解析
- ログエントリの一覧表示と詳細表示
- 複数のDLTファイルの同時読み込みと比較
- 設定情報の保存と読み込み

### 2. ログ表示機能
- タイムスタンプ、ECU ID、アプリケーションID、コンテキストID、ログレベル、ペイロード等の全フィールド表示
- 時系列順での表示
- ログエントリの詳細表示モード（ペイロードの16進数表示含む）
- カラーコーディング（ログレベルに応じた色分け表示）

### 3. フィルタリング機能
- アプリケーションID / コンテキストIDによるフィルタリング
- ログレベル（DEBUG, INFO, WARN, ERROR）によるフィルタリング
- メッセージタイプによるフィルタリング
- 時間範囲によるフィルタリング
- 複合フィルタ（AND/OR条件）の適用

### 4. 検索機能
- テキスト全文検索（大文字/小文字区別、正規表現対応）
- 検索結果のハイライト表示
- 検索結果間のナビゲーション

### 5. ユーザーインターフェース
- マルチペイン表示（ファイルブラウザ、ログ一覧、詳細表示）
- ステータスバー（現在のフィルタ状態、選択中のエントリ情報等）
- コマンドライン（検索、フィルタ等のコマンド入力）
- ヘルプ画面
- 直感的なキーボードナビゲーション（vim風）
- カラーコーディングによるログレベルの視覚化

## Future Work（将来的な拡張機能）
- リアルタイムログ監視機能
- キーボードショートカットのカスタマイズ
- マウス操作サポート
- 統計情報の表示（ログレベル分布、アプリケーション別メッセージ数等）
- エクスポート機能（CSV, JSONなど）

## 技術仕様

### 1. 開発言語とライブラリ
- 言語: Rust
- TUIフレームワーク: [tui-rs](https://github.com/fdehau/tui-rs) または [Cursive](https://github.com/gyscos/cursive)
- DLTパーサー: 自作またはexisting crates

### 2. DLTフォーマット解析
DLTメッセージフォーマットの基本構造:
- DltStorageHeader (16バイト)
- DltStandardHeader (4バイト)
- DltStandardHeaderExtra (オプショナル、最大約10バイト)
- DltExtendedHeader (オプショナル、最大約10バイト)
- ペイロード (可変長)

### 3. パフォーマンス要件
- 大容量ログファイル（数GB）を効率的に処理できる設計
- メモリ使用の最適化（ストリーミング読み込み、インデックス作成）
- 検索・フィルタリング処理の高速化（並列処理、インデックス活用）

### 4. エラーハンドリング
- 不正なフォーマットのDLTファイル検出
- 読み込み失敗時の適切なエラーメッセージ表示
- 予期せぬクラッシュの防止と適切なエラーリカバリ

## 実装アプローチ

### 1. アーキテクチャ
- Model-View-Controllerパターンの採用
- 機能モジュールの分離（ファイル読み込み、解析、表示、フィルタリング等）
- 設定情報の外部ファイル化

### 2. ユーザーエクスペリエンス
- 直感的なナビゲーション（vim風のキーバインド）
- 反応性の高いUI（長時間処理のバックグラウンド実行）
- プログレスインジケータ（大容量ファイル読み込み時）

### 3. 開発ステップ
1. DLTパーサーモジュールの実装とテスト
2. 基本的なTUI表示機能の実装
3. フィルタリング・検索機能の実装
4. UIの改善とユーザビリティの向上
5. パフォーマンスの最適化

### 4. モジュール構成
- **main.rs**: アプリケーションのエントリーポイント、引数処理
- **dlt_parser.rs**: DLTバイナリフォーマットの解析モジュール
- **filters.rs**: ログフィルタリングの実装
- **ui.rs**: TUIの表示・制御
- **config.rs**: 設定管理

## 開発アプローチの詳細

### Rustの優位性
Rustはパフォーマンスと安全性を兼ね備えた言語であり、以下の利点があります：
- メモリ安全性（所有権システム）
- 高速な実行速度（C/C++と同等）
- クロスプラットフォーム対応（macOS、Ubuntu）
- 優れた並行処理サポート

### DLTパーサーの実装
DLTパーサーはログデータのバイナリフォーマットを正確に解析する必要があります：
- バイナリデータの効率的な読み込み（mmap等の活用）
- DLT仕様に準拠したヘッダー解析
- エンディアン変換の適切な処理
- 不正なフォーマットに対する堅牢性

### TUI実装のアプローチ
TUIフレームワークを使用して効率的なインターフェースを構築します：
- レイアウト管理（分割ペイン、サイズ調整）
- キーボードイベント処理
- スクロール可能なリスト表示
- カラーとスタイルの適用

### データ構造の最適化
大量のログデータを効率的に管理するための工夫：
- 遅延読み込み（必要な部分のみメモリに展開）
- インデックス作成（高速検索のため）
- フィルタリング結果のキャッシング

## コマンドラインインターフェース

```
dlt-tui [OPTIONS] [FILES]...

OPTIONS:
  -h, --help                   ヘルプメッセージを表示
  -v, --version                バージョン情報を表示
  -f, --filter <FILTER>        起動時に適用するフィルタを指定（形式: "app_id=ABC,ctx_id=XYZ,level=ERROR"）
  -s, --search <PATTERN>       起動時に検索するパターンを指定
  -c, --config <FILE>          設定ファイルを指定（デフォルト: ~/.config/dlt-tui/config.toml）

FILES:
  解析するDLTファイルのパス（複数指定可）
```

## キーバインド

```
基本操作:
  q, Ctrl+c    終了
  h, ?         ヘルプ表示
  /            検索モード
  f            フィルタモード
  Tab          ペイン切替
  Esc          モードキャンセル

ナビゲーション:
  j, ↓         下に移動
  k, ↑         上に移動
  g, Home      先頭に移動
  G, End       末尾に移動
  PgUp, Ctrl+b ページアップ
  PgDn, Ctrl+f ページダウン

フィルタモード:
  a            アプリケーションIDでフィルタ
  c            コンテキストIDでフィルタ
  l            ログレベルでフィルタ
  t            タイムスタンプでフィルタ
  r            フィルタリセット

表示モード:
  Enter        詳細表示切替
  w            ワイド表示切替
  r            表示更新
```

## プロジェクト管理

### 開発環境セットアップ
1. Rustとcargoのインストール
   ```
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   ```

2. プロジェクト初期化
   ```
   cargo new dlt-tui
   cd dlt-tui
   ```

3. 依存関係の追加（Cargo.toml）
   ```toml
   [dependencies]
   clap = "3.0"           # コマンドライン引数解析
   tui = "0.16"           # TUIフレームワーク
   crossterm = "0.22"     # ターミナル操作
   byteorder = "1.4"      # バイナリデータ解析
   regex = "1.5"          # 正規表現サポート
   chrono = "0.4"         # 日付・時間操作
   ```

### テスト戦略
- ユニットテスト：各モジュールの機能テスト
- インテグレーションテスト：モジュール間の連携テスト
- サンプルDLTファイルを使用した実際の動作確認

### ドキュメンテーション
- README.md：基本的な使用方法と概要
- コードドキュメント（RustDoc）：関数とデータ構造の詳細説明
- ユーザーマニュアル：詳細な使用方法とチュートリアル

## まとめ
このDLTログビューアTUIツールは、Rustの優れたパフォーマンスと安全性を活かし、コマンドラインベースの効率的なログ解析をサポートします。モジュール分割による保守性の高いアーキテクチャを採用し、将来的な機能拡張にも対応しやすい設計となっています。ユーザーエクスペリエンスを重視した直感的なインターフェースにより、効率的なDLTログの解析作業を実現します。
